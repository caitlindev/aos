express = require 'express'
router = express.Router()
busboy = require 'connect-busboy'
concat= require 'concat-stream'

router.use busboy()

router.post '/', (req, res, next) ->
  console.log req.busboy
  req.busboy.on 'file', (fieldName, file, filename, encoding, mimetype) ->
    file.pipe concat (body) ->
      parsedBody = JSON.parse body
      res.send "hello " + parsedBody.name + "!"
  req.pipe req.busboy

router.get '/', (req, res, next) ->
  res.send '
    <form method="POST" enctype="multipart/form-data">
      <input type="file" name="bob" />
      <input type="submit" name="go" />
    </form>
  '

module.exports = router

